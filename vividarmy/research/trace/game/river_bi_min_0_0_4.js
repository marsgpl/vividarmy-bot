(window.RiverBI=function(){var t=function(){this.SDK_VERSION="0.0.4";this.INTERFACE_VERSION="0.1.0";this.DEBUG_MODE=false;this.BATCH_POST_PERTIME=10;this.POST_RETRY_MAX=6;this.POST_RETRY_TIME=3;this.LOCAL_CACHE_MODE=true;this.LOCAL_CACHE_KEY="RiverBI_cache";this.LOCAL_CACHE_MAX_LEN=200;this.POST_URL="https://bi-tracker-global.rivergame.net/event/tracker";this.BACK_URL="";this.BI_EVENT={launch:"launch",login:"login"};this.app_id="102";this.device_id="";this.temp_id="";this.old_temp_id="";this.uid="";this.sid=-1;this.platform="";this.app_version="";this.channel="";this.unionid="";this.country="";this.inited=false};t.prototype.init=function(t){if(t.platform){this.platform=t.platform}if(t.app_id!=null){this.app_id=t.app_id}if(t.channel!=null){this.channel=t.channel}if(t.country!=null){this.country=t.country}if(t.debug){this.DEBUG_MODE=true;this.app_id="999"}if(t.isCN){this.POST_URL="https://bi-tracker-cn.rivergame.net/event/tracker"}else{this.BACK_URL="https://biapi.topwargame.com/event/tracker"}if(t.post_url){this.POST_URL=t.post_url}if(t.back_url){this.BACK_URL=t.back_url}if(t.temp_id){this.old_temp_id=t.temp_id}var e=cc.sys.localStorage.getItem("RiverBI_temp_id");if(!e){e=this.guid();cc.sys.localStorage.setItem("RiverBI_temp_id",e)}this.temp_id=e;this.biHttpUtils=new i(this);this.localCache=new s(this);this.beginGameTime=(new Date).getTime();this.totalHideGameTime=0;this.lastHideGameTime=0;this.index=0;var n=this;cc.game.on(cc.game.EVENT_HIDE,function(){n.onHideFunc()},n);cc.game.on(cc.game.EVENT_SHOW,function(){n.onShowFunc()},n);this.BIlog("sys.getNetworkType:",cc.sys.getNetworkType());this.inited=true;if(t.success){var o={tempId:this.tempId};t.success(o)}};t.prototype.updateInfo=function(t){if(!this.inited)return;if(t.uid!=null){this.uid=t.uid}if(t.device_id!=null){this.device_id=t.device_id}if(t.sid!=null){this.sid=t.sid}if(t.app_version!=null){this.app_version=t.app_version}if(t.unionid!=null){this.unionid=t.unionid}if(t.channel!=null){this.channel=t.channel}if(t.country!=null){this.country=t.country}};t.prototype.onHideFunc=function(t){this.lastHideGameTime=(new Date).getTime();this.BIlog("BI onHide")};t.prototype.onShowFunc=function(t){this.lastShowGameTime=(new Date).getTime();this.totalHideGameTime+=this.lastShowGameTime>this.lastHideGameTime&&this.lastHideGameTime!=0?this.lastShowGameTime-this.lastHideGameTime:0;this.lastHideGameTime=0;this.BIlog("BI onShow");if(this.LOCAL_CACHE_MODE){try{var i=this.localCache.getStorageSync();this.BIlog("BI insert queue from cache:",i.length);while(i.length>0){var e=i.pop();this.biHttpUtils.doSend(e)}}catch(t){this.BIlog("BI catch",t.message)}}};t.prototype.sendToBI=function(t,i){if(!this.inited)return;if(i==null){i={}}this.index+=1;var e={};var s=(new Date).getTime();e.event=t;e.temp_id=this.temp_id;e.platform=this.platform;e.qn=this.index;e.time=i.server_time||s;if(this.DEBUG_MODE){e.debug=1}else{e.debug=0}this.uid&&(e.uid=this.uid);this.device_id&&(e.device_id=this.device_id);this.sid&&(e.sid=this.sid);this.app_version&&(e.app_version=this.app_version);i.oltime=Math.round(s-this.beginGameTime-this.totalHideGameTime);this.country&&(i.country=this.country);this.unionid&&(i.unionid=this.unionid);this.channel&&(i.channel=this.channel);this.old_temp_id&&(i.old_temp_id=this.old_temp_id);e.eventinfo=i;this.biHttpUtils.doSend(e)};t.prototype.BIlog=function(t,i){if(!this.DEBUG_MODE)return;if(CC_DEBUG){console.log(t,i)}};t.prototype.guid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var i=Math.random()*16|0,e=t=="x"?i:i&3|8;return e.toString(16)})};var i=function(){function t(t){this.storageTime=0;this.onHideTimes=0;this.protectTime=0;this.sendFailPack=new Array;this.bi_ctx=t;this.post_fail_count=0;this.queue=new e(t.BATCH_POST_PERTIME);setInterval(this.checkQueue.bind(this),150)}t.prototype.doSend=function(t){try{this.queue.push(t)}catch(t){this.bi_ctx.BIlog("BI catch:",t.message)}};t.prototype.getPostUrl=function(){var t=Math.floor(this.post_fail_count/5)%2;return(t==0?this.bi_ctx.POST_URL:this.bi_ctx.BACK_URL)||this.bi_ctx.POST_URL};t.prototype.checkQueue=function(){if(this.sendFailPack.length>0&&this.protectTime++>this.bi_ctx.POST_RETRY_TIME){var t=this.sendFailPack.shift();this.httpPost(this.getPostUrl(),t,this.successHandler.bind(this),this.failHandler.bind(this));this.protectTime=0}this.checkStorageAddQueue();try{while(this.queue.size()>0){this.bi_ctx.BIlog("BI queue:",this.queue);var i=this.queue.splice();if(i.length===0){continue}this.postDataArray(i);break}}catch(t){this.bi_ctx.BIlog("BI catch:",t.message)}};t.prototype.postDataArray=function(t){try{if(t){var i={rid:this.bi_ctx.temp_id.substring(0,8)+(new Date).getTime().toString()+Math.floor(Math.random()*900+100).toString(),v:this.bi_ctx.INTERFACE_VERSION,s:"client",rc:0,app:this.bi_ctx.app_id,l:t};this.bi_ctx.BIlog("BI post data:",i);this.httpPost(this.getPostUrl(),i,this.successHandler.bind(this),this.failHandler.bind(this))}}catch(t){this.bi_ctx.BIlog("BI catch:",t.message)}};t.prototype.checkOnHide=function(){this.onHideTimes+=1;if(this.onHideTimes>=50){this.onHideTimes=0}};t.prototype.checkStorageAddQueue=function(){if(!this.bi_ctx.LOCAL_CACHE_MODE){return}this.storageTime+=1;if(this.storageTime>=100){this.storageTime=0;try{var t=this.bi_ctx.localCache.getStorageSync();if(!t||t.length<1)return;this.bi_ctx.BIlog("BI insert queue from cache",t);while(t.length>0){var i=t.pop();this.queue.push(i)}}catch(t){this.bi_ctx.BIlog("BI catch:",t.message)}}};t.prototype.successHandler=function(t){if(t=="fail"){this.bi_ctx.BIlog("BI post fail.");return}this.bi_ctx.BIlog("BI post success.",t)};t.prototype.failHandler=function(t,i){this.bi_ctx.BIlog("BI post fail",i.toString());this.post_fail_count++;try{this.bi_ctx.BIlog("BI post ",i.toString());i.statusCode=t;i.rc+=1;if(i.rc>=this.bi_ctx.POST_RETRY_MAX){this.bi_ctx.BIlog("BI fail post retryNum",i.rc);this.bi_ctx.localCache.setStorageSync(i.l)}else{this.sendFailPack.push(i)}}catch(t){this.bi_ctx.BIlog("BI catch:",t.message)}};t.prototype.httpPost=function(t,i,e,s){try{let h=function(t){t.onerror=null;t.ontimeout=null;t.onreadystatechange=null};var n=cc.loader.getXMLHttpRequest();var o=this;n.onerror=function(t){h(n);n.abort();o.bi_ctx.BIlog("BI post error:",t);if(s)s(n.status,i)};n.ontimeout=function(t){h(n);n.abort();o.bi_ctx.BIlog("BI post timeout!",t);if(n.readyState!==4){if(s)s(408,i)}};n.onreadystatechange=function(){o.bi_ctx.BIlog("BI post readyState",n.readyState);if(n.readyState==4){o.bi_ctx.BIlog("BI post responseText",n.responseText);if(n.status>=200&&n.status<400){h(n);if(e)e(n.responseText)}else{h(n);n.abort();if(s)s(n.status,i)}}};n.open("POST",t,true);n.timeout=6*1e3;n.setRequestHeader("Content-Type","application/json;charset=UTF-8");n.send(JSON.stringify(i))}catch(t){this.bi_ctx.BIlog("BI post error:",t.message)}};return t}();var e=function(){function t(t){this.elements=new Array;this.batch_post_pertime=t}t.prototype.push=function(t){if(t==null){return false}this.elements.unshift(t);return true};t.prototype.pop=function(){return this.elements.pop()};t.prototype.size=function(){return this.elements.length};t.prototype.empty=function(){return this.size()==0};t.prototype.clear=function(){delete this.elements;this.elements=new Array};t.prototype.concat=function(t){for(var i in t){this.push(i)}};t.prototype.splice=function(){var t=0;var i=this.batch_post_pertime;if(this.elements.length>i){t=this.elements.length-i}else{i=this.elements.length}return this.elements.splice(t,i)};return t}();var s=function(){function t(t){this.bi_ctx=t}t.prototype.getStorageSync=function(){if(!this.bi_ctx.LOCAL_CACHE_MODE){return new Array}try{var t=cc.sys.localStorage.getItem(this.bi_ctx.LOCAL_CACHE_KEY);if(t){var i=JSON.parse(t);cc.sys.localStorage.removeItem(this.bi_ctx.LOCAL_CACHE_KEY);return i}}catch(t){this.bi_ctx.BIlog("BI get cache error:",t.message)}return new Array};t.prototype.setStorageSync=function(t){if(!this.bi_ctx.LOCAL_CACHE_MODE){return}this.bi_ctx.BIlog("BI fail send,save to cache:",t);try{var i=this.getStorageSync();i.push.apply(i,t);if(i.length>this.bi_ctx.LOCAL_CACHE_MAX_LEN){i.length=this.bi_ctx.LOCAL_CACHE_MAX_LEN}cc.sys.localStorage.setItem(this.bi_ctx.LOCAL_CACHE_KEY,JSON.stringify(i))}catch(t){this.bi_ctx.BIlog("BI set cache error:",t.message)}};return t}();return new t}());